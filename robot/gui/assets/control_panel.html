<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Панель управления</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.0/css/bulma.min.css">

    <style>
        img {
            max-width: 40%;
            border: 2px solid #444;
            margin-bottom: 20px;
        }
    </style>

    <script src="/static/js/ws_video_stream.js"></script>
    <script src="/static/js/gui_channel.js"></script>

    <script>
        CHANNEL_PATH = "/control_panel";

        const streams = {};
        var activeStream = null;

        window.addEventListener("channel_ready", function (event) {

            event.detail.channel.addEventListener("code_stream", function(event) {
                addStream(event.detail.id, event.detail.url, event.detail.name);
            });

        });

        function addStream(id, url, name) {
            console.log(`Adding stream ${name} (${url})`);
            var imageElement = document.getElementById("stream-image");
            streams[id] = {"id": id, "url": url, "name": name, "stream": new WSVideoStream(url, imageElement)};
            var tabs = document.getElementById("streams-tabs");
            var tabsList = tabs.getElementsByTagName("ul")[0];
            tabsList.insertAdjacentHTML("beforeend", `<li id="stream-button-${id}"><a onclick="onStreamClicked('${id}')">${name}</a></li>`);
        }

        function onStreamClicked(id) {
            if (activeStream?.id == id) {
                stopActiveStream();
            }
            else {
                setActiveStream(id);
            }
        }

        function setActiveStream(id) {
            if (activeStream) {
                stopActiveStream();
            }

            var stream = streams[id];
            if (!stream) {
                console.log(`Unknown stream ${id}`);
                return;
            }

            activeStream = stream;
            document.getElementById(`stream-button-${id}`).classList.add("is-active");
            activeStream.stream.begin();
        }

        function stopActiveStream() {
            if (!activeStream) {
                return;
            }

            activeStream.stream.stop();
            var tabsList = document.getElementById("streams-tabs").getElementsByTagName("ul")[0];
            tabsList.childNodes.forEach((el) => {
                el.classList?.remove("is-active");
            });
            activeStream = null;
        }

    </script>
</head>
<body>
<p class="subtitle is-4 has-text-centered mt-3 mb-0">Панель управления</p>
<section class="section is-fullwidth container is-fluid">
    <div class="box">
        <p class="subtitle is-4 has-text-centered">Потоки</p>
        <div id="streams-tabs" class="tabs">
            <ul>

            </ul>
        </div>
        <img id="stream-image">
    </div>
</section>



</body>
</html>
